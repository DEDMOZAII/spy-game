<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–º–Ω–∞—Ç–∞ {{ room_code }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #343a40; color: white; }
        .card { background-color: #495057; border: none; cursor: pointer; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .role-card { height: 300px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; text-align: center; perspective: 1000px; }
        .flip-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .flip-inner { transform: rotateY(180deg); }
        .flip-front, .flip-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 10px; padding: 20px;}
        .flip-front { background-color: #6c757d; color: white; }
        .flip-back { background-color: #dc3545; color: white; transform: rotateY(180deg); }
        .spy-card .flip-back { background-color: #212529; border: 2px solid red; }
        .citizen-card .flip-back { background-color: #198754; }
    </style>
</head>
<body class="p-3">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5>–ö–æ–º–Ω–∞—Ç–∞: <span class="badge bg-warning text-dark">{{ room_code }}</span></h5>
            <a href="/" class="btn btn-sm btn-outline-light">–í—ã—Ö–æ–¥</a>
        </div>

        <!-- LOBBY VIEW -->
        <div id="lobbyView">
            <h3 class="text-center mb-4">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</h3>
            <ul id="playerList" class="list-group mb-4 text-dark">
                <!-- Players go here -->
            </ul>
            <div id="adminControls" class="d-none text-center">
                <button id="startBtn" class="btn btn-success btn-lg px-5">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            </div>
            <div id="waitingMsg" class="text-center text-muted d-none">
                –û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –Ω–∞—á–Ω–µ—Ç –∏–≥—Ä—É...
            </div>
        </div>

        <!-- GAME VIEW -->
        <div id="gameView" class="d-none">
            <h4 class="text-center mb-3">–¢–µ–º–∞: <span id="categoryName" class="badge bg-info">...</span></h4>
            
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <div id="gameCard" class="role-card" onclick="this.classList.toggle('flipped')">
                        <div class="flip-inner">
                            <div class="flip-front">
                                <h3>–í–ê–®–ê –†–û–õ–¨</h3>
                                <p class="small text-muted">(–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å)</p>
                            </div>
                            <div class="flip-back">
                                <h2 id="roleTitle">...</h2>
                                <h4 id="wordText" class="mt-3">...</h4>
                            </div>
                        </div>
                    </div>
                    <p class="text-center mt-3 text-muted">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Ä–æ–ª—å.</p>
                    
                    <div class="d-grid gap-2 mt-4">
                         <button class="btn btn-outline-warning" type="button" data-bs-toggle="collapse" data-bs-target="#possibleWords" aria-expanded="false" aria-controls="possibleWords">
                            üìú –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤
                          </button>
                    </div>
                    <div class="collapse mt-2" id="possibleWords">
                      <div class="card card-body bg-dark text-white">
                        <ul id="wordsList" class="list-unstyled mb-0" style="columns: 2;">
                            <!-- Words will be injected here -->
                        </ul>
                      </div>
                    </div>

                    <div id="gameAdminControls" class="d-grid gap-2 mt-4 d-none">
                        <button id="restartBtn" class="btn btn-warning">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                    </div>
                    <button class="btn btn-danger w-100 mt-3" onclick="window.location.href='/'">–ó–∞–∫–æ–Ω—á–∏—Ç—å –∏–≥—Ä—É</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const roomCode = "{{ room_code }}";
        const username = sessionStorage.getItem('username');
        const isAdmin = sessionStorage.getItem('is_admin') === 'true';

        if (!username) {
            window.location.href = '/';
        }

        // Re-join logic specifically for page reload or initial landing
        socket.emit('join_room', { username: username, room_code: roomCode });

        // DOM Elements
        const lobbyView = document.getElementById('lobbyView');
        const gameView = document.getElementById('gameView');
        const playerList = document.getElementById('playerList');
        const adminControls = document.getElementById('adminControls');
        const waitingMsg = document.getElementById('waitingMsg');
        const startBtn = document.getElementById('startBtn');
        const categoryName = document.getElementById('categoryName');
        const wordsList = document.getElementById('wordsList');
        const gameAdminControls = document.getElementById('gameAdminControls');
        const restartBtn = document.getElementById('restartBtn');


        // Logic
        if (isAdmin) {
            adminControls.classList.remove('d-none');
        } else {
            waitingMsg.classList.remove('d-none');
        }

        startBtn.addEventListener('click', () => {
            socket.emit('start_game', { room_code: roomCode });
        });

        restartBtn.addEventListener('click', () => {
            socket.emit('restart_game', { room_code: roomCode });
        });

        // Socket Events
        socket.on('update_player_list', (data) => {
            playerList.innerHTML = '';
            data.players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = p;
                playerList.appendChild(li);
            });
        });

        socket.on('game_started', (data) => {
            lobbyView.classList.add('d-none');
            gameView.classList.remove('d-none');

            if (isAdmin) {
                gameAdminControls.classList.remove('d-none');
            }
            
            const backFace = document.querySelector('.flip-back');
            const roleTitle = document.getElementById('roleTitle');
            const wordText = document.getElementById('wordText');
            
            categoryName.textContent = data.category;
            
            // Fill possible words list
            wordsList.innerHTML = '';
            data.possible_words.forEach(word => {
                const li = document.createElement('li');
                li.textContent = word;
                li.style.fontSize = '0.9rem';
                wordsList.appendChild(li);
            });

            if (data.is_spy) {
                backFace.parentElement.parentElement.classList.add('spy-card');
                roleTitle.textContent = "–¢–´ –®–ü–ò–û–ù!";
                wordText.textContent = "–£–≥–∞–¥–∞–π —Å–ª–æ–≤–æ!";
            } else {
                backFace.parentElement.parentElement.classList.add('citizen-card');
                roleTitle.textContent = "–ú–∏—Ä–Ω—ã–π";
                wordText.textContent = data.word;
            }
        });

        socket.on('game_restarted', () => {
            gameView.classList.add('d-none');
            lobbyView.classList.remove('d-none');
            const gameCard = document.getElementById('gameCard');
            gameCard.classList.remove('flipped', 'spy-card', 'citizen-card');
        });

        socket.on('error', (data) => {
            console.error(data.message);
        });
    </script>
</body>
</html>
